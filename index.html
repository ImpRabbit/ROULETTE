<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>縛り順位ルーレット（4人固定・完全ランダム）</title>
<style>
  :root {
    --bg:#0b6b2b;     /* 全体背景を緑で統一 */
    --acc:#6cf;       /* ボタン背景色 */
    --txt:#fff;       /* 文字白 */
    --stroke:#000;    /* 文字ふち黒 */
  }

  html, body {
    margin:0;
    height:100%;
    background:var(--bg);
    color:var(--txt);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  /* 全要素に黒ふち＋白文字 */
  :where(body, body *) {
    color: var(--txt) !important;
    text-shadow:
      -1px -1px 0 var(--stroke),
       1px -1px 0 var(--stroke),
      -1px  1px 0 var(--stroke),
       1px  1px 0 var(--stroke);
  }

  header{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.08);background-color:var(--bg)}
  h1{margin:0;font-size:20px;letter-spacing:.3px}
  .wrap{max-width:760px;margin:18px auto;padding:0 16px}
  .card{background:var(--bg);border-radius:14px;padding:14px 16px;border:1px solid rgba(255,255,255,.15)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:700;background:var(--acc);box-shadow:0 8px 24px rgba(122,173,221,.28)}
  button:disabled{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:separate;border-spacing:0 1px}
  th,td{padding:6px 6px;text-align:center}
  thead th{font-size:13px;opacity:.9}
  tbody tr{background:var(--bg)}
  .rank-badge{display:inline-block;min-width:2.4em;padding:.2em .5em;border-radius:999px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2)}
  .arrow{display:inline-block;min-width:1.6em;padding:0 .2em}
  .slot{display:inline-block;min-width:4em;font-variant-numeric:tabular-nums}
</style>
</head>
<body>
  <header><h1>縛り順位ルーレット（4人固定・完全ランダム）</h1></header>
  <div class="wrap">
    <div class="card">
      <div class="controls">
        <button id="spinBtn">スピン！</button>
        <button id="copyBtn" title="結果をテキストでコピー">コピー</button>
      </div>

      <table aria-label="実順位から縛り順位への対応">
        <thead>
          <tr>
            <th>実際の順位</th>
            <th></th>
            <th>縛り順位</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const N = 4; // 4人固定

  const rowsEl = document.getElementById('rows');
  const spinBtn = document.getElementById('spinBtn');
  const copyBtn = document.getElementById('copyBtn');

  buildRows();

  spinBtn.addEventListener('click', async ()=>{
    disable(true);
    try{
      const perm = uniformPermutation(N); // ← 完全ランダム順列
      await spinSlotsTo(perm);
    } finally {
      disable(false);
    }
  });

  copyBtn.addEventListener('click', async ()=>{
    const mapping = readCurrentMapping();
    const text = mapping.map(([i,v]) => `実順位 ${i} → 縛り順位 ${v ?? '（未決定）'}`).join('\n');
    try{ await navigator.clipboard.writeText(text); }catch{}
  });

  function buildRows(){
    rowsEl.innerHTML = '';
    for(let i=1;i<=N;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="rank-badge">${i} 位</span></td>
        <td><span class="arrow">→</span></td>
        <td><span class="slot" data-slot="${i}">—</span></td>
      `;
      rowsEl.appendChild(tr);
    }
  }

  function readCurrentMapping(){
    const res=[];
    for(let i=1;i<=N;i++){
      const el = rowsEl.querySelector(`[data-slot="${i}"]`);
      const val = parseInt(el?.dataset.value || 'NaN',10);
      res.push([i, Number.isFinite(val)? val : null]);
    }
    return res;
  }

  function disable(b){ spinBtn.disabled=b; copyBtn.disabled=b; }

  function cryptoRandInt(min, max){
    const range = max - min + 1;
    const maxUint = 0xFFFFFFFF;
    const limit = Math.floor(maxUint / range) * range;
    let x;
    do{
      const buf = new Uint32Array(1);
      crypto.getRandomValues(buf);
      x = buf[0];
    }while(x >= limit);
    return min + (x % range);
  }

  // ★ 完全ランダム：全順列が均等に出る Fisher–Yates shuffle
  function uniformPermutation(n){
    const arr = Array.from({length:n}, (_,i)=>i+1);
    for(let i=n-1; i>0; i--){
      const j = cryptoRandInt(0, i);
      const tmp = arr[i];
      arr[i] = arr[j];
      arr[j] = tmp;
    }
    return arr;
  }

  function spinSlotsTo(perm){
    const tasks = [];
    for(let i=1;i<=N;i++){
      const slotEl = rowsEl.querySelector(`[data-slot="${i}"]`);
      tasks.push(spinOne(slotEl, perm[i-1], i*120));
    }
    return Promise.all(tasks);
  }

  function spinOne(el, target, delayMs){
    return new Promise(resolve=>{
      setTimeout(()=>{
        const start = performance.now();
        const dur = 900 + cryptoRandInt(0, 400);
        let lastShown = null;
        const tick = (now)=>{
          const t = now - start;
          if(t < dur){
            const show = 1 + cryptoRandInt(0, N-1);
            if(show !== lastShown){
              el.textContent = `${show} 位`;
              lastShown = show;
            }
            requestAnimationFrame(tick);
          }else{
            el.textContent = `${target} 位`;
            el.dataset.value = String(target);
            resolve();
          }
        };
        requestAnimationFrame(tick);
      }, delayMs);
    });
  }
})();
</script>
</body>
</html>
